#!/usr/bin/python

from __future__ import division

import binascii
import struct
import traceback

from twisted.internet import defer, reactor, serialport, protocol

import txros
from txros import util

import genpy
from std_msgs.msg import Header
from geometry_msgs.msg import Point, Vector3

from thruster_handling.msg import ThrusterInfo, ThrusterCommand
from kill_handling.listener_txros import KillListenerTxROS
from uf_common import interpolate


LIFETIME = 1

class Thruster(object):
    CALIBRATION_DATA = (-1., 1.), (-1., 1.)
    CALIBRATION_DATA = (-19.146524926732493, -18.684424213862787, -18.148332646474387, -17.368919736297556, -16.690411739927985, -15.28330822668237, -14.553070496019217, -13.227667118681762, -12.18800894029944, -11.08681336195058, -9.856704001314467, -8.802858920493616, -7.536529622442058, -6.293419402658093, -4.862321321300986, -3.756700889136877, -2.529556636727477, -1.5545834347369945, -0.7477090606759029, -0.1504906467677264, -0.0, 0.28820851963579663, 1.0212288903270956, 1.9966126457643543, 3.000780759525484, 4.064980910614996, 5.350013199019609, 6.422059482647473, 7.803617448093782, 9.316871835855466, 10.294810146072649, 12.065025374465613, 13.234190356780509, 14.417177305136807, 15.835274527346058, 16.911882515938082, 17.92170714385476, 18.880440676172853, 19.64813000459178, 20.739746002515883, 20.94566136459822), (-1.0, -0.95, -0.9, -0.85, -0.8, -0.75, -0.7, -0.65, -0.6, -0.55, -0.5, -0.45, -0.4, -0.35, -0.3, -0.25, -0.2, -0.15, -0.1, -0.05, 0.0, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.35, 0.4, 0.45, 0.5, 0.55, 0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1.0)
    
    def __init__(self, nh, bus, name, config, info_pub, kill_listener):
        self._nh = nh
        self._bus = bus
        self._name = name
        self._config = config
        self._info_pub = info_pub
        self._kill_listener = kill_listener
        
        self._command_sub = nh.subscribe('/thrusters/command/' + self._name, ThrusterCommand, self._got_command)
        
        self._send_command(0)
        
        kill_listener.killed_variable.when_satisfies(lambda killed: killed).watch(lambda killed: self._send_command(0))
        
        self._info_publisher()
    
    def _got_command(self, msg):
        if not self._kill_listener.killed_variable.value:
            power = interpolate.sample_curve(self.CALIBRATION_DATA, msg.force)
            self._send_command(power)
    
    def _send_command(self, power):
        self._bus.write(self._config['node_id'], 0x4, struct.pack('<f', power))
        print self._name, power
    
    @util.cancellableInlineCallbacks
    def _info_publisher(self):
        while True:
            self._info_pub.publish(ThrusterInfo(
                header=Header(
                    stamp=self._nh.get_time(),
                    frame_id=self._config['frame_id'],
                ),
                id=self._name,
                lifetime=genpy.Duration(LIFETIME),
                active=True,
                position=Point(*self._config['position']),
                direction=Vector3(*self._config['direction']),
                min_force=self.CALIBRATION_DATA[0][0],
                max_force=self.CALIBRATION_DATA[0][-1],
                torque_per_force=Vector3(*self._config.get('torque_per_force', [0, 0, 0])),
            ))
            yield util.sleep(LIFETIME/2)

class BusProtocol(protocol.Protocol):
    pass

class Bus(object):
    def __init__(self, nh, port):
        self._protocol = BusProtocol()
        self._port = serialport.SerialPort(self._protocol, port, reactor, 115200)
    
    def _send(self, network_id, flags, csr_address, payload):
        header = struct.pack('<HBBBB', 0x5FF5, network_id, flags, csr_address, len(payload))
        packet = header + struct.pack('<I', binascii.crc32(header) & 0xffffffff) + payload + struct.pack('<I', binascii.crc32(payload) & 0xffffffff)
        print packet.encode('hex')
        self._protocol.transport.write(packet)
    
    def write(self, node_id, address, data):
        self._send(node_id, 0x00, address, data)

@util.cancellableInlineCallbacks
def main():
    nh = yield txros.NodeHandle.from_argv('videoray_m5_thruster_driver')
    
    info_pub = nh.advertise('/thrusters/info', ThrusterInfo)
    kill_listener = KillListenerTxROS(nh)
    
    for config in (yield nh.get_param('~buses')):
        bus = Bus(nh, config['port'])
        for name, config2 in config['thrusters'].iteritems():
            thruster = Thruster(nh, bus, name, config2, info_pub, kill_listener)
    
    yield defer.Deferred() # never exit
util.launch_main(main)
